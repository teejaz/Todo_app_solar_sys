<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Dashboard - Progress Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .contribution-box {
        transition: all 0.2s ease;
      }
      .contribution-box:hover {
        transform: scale(1.1);
        stroke: #374151;
        stroke-width: 1;
      }
      .level-0 { fill: #161b22; }
      .level-1 { fill: #0e4429; }
      .level-2 { fill: #006d32; }
      .level-3 { fill: #26a641; }
      .level-4 { fill: #39d353; }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-amber-400">Task Dashboard</h1>
            <a href="/" class="text-gray-400 hover:text-white transition-colors">‚Üê Back to Goal Visualizer</a>
          </div>
          <div class="flex items-center space-x-6">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-400" id="currentStreak">0</div>
              <div class="text-xs text-gray-400">Current Streak</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-400" id="totalTasks">0</div>
              <div class="text-xs text-gray-400">Total Tasks</div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Stats Overview -->
      <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-3xl font-bold text-amber-400" id="uniqueDays">0</div>
              <div class="text-sm text-gray-400 mt-1">Active Days</div>
            </div>
            <div class="text-amber-400 text-2xl">üìÖ</div>
          </div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-3xl font-bold text-green-400" id="longestStreak">0</div>
              <div class="text-sm text-gray-400 mt-1">Longest Streak</div>
            </div>
            <div class="text-green-400 text-2xl">üî•</div>
          </div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-3xl font-bold text-blue-400" id="avgPerDay">0</div>
              <div class="text-sm text-gray-400 mt-1">Avg Tasks/Day</div>
            </div>
            <div class="text-blue-400 text-2xl">üìä</div>
          </div>
        </div>
        
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-3xl font-bold text-purple-400" id="goalCount">0</div>
              <div class="text-sm text-gray-400 mt-1">Goals Tracked</div>
            </div>
            <div class="text-purple-400 text-2xl">üéØ</div>
          </div>
        </div>
      </section>

      <!-- Contribution Graph -->
      <section class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
        <h2 class="text-xl font-semibold text-white mb-4">Task Completion Activity</h2>
        <div class="mb-4">
          <div class="flex items-center space-x-4 text-sm text-gray-400">
            <span>Less</span>
            <div class="flex space-x-1">
              <div class="w-3 h-3 level-0 rounded-sm"></div>
              <div class="w-3 h-3 level-1 rounded-sm"></div>
              <div class="w-3 h-3 level-2 rounded-sm"></div>
              <div class="w-3 h-3 level-3 rounded-sm"></div>
              <div class="w-3 h-3 level-4 rounded-sm"></div>
            </div>
            <span>More</span>
          </div>
        </div>
        <div id="contributionGraph" class="overflow-x-auto">
          <!-- SVG will be generated here -->
        </div>
      </section>

      <!-- Goal Breakdown -->
      <section class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
        <h2 class="text-xl font-semibold text-white mb-4">Goal Progress</h2>
        <div id="goalBreakdown" class="space-y-3">
          <!-- Goal stats will be populated here -->
        </div>
      </section>

      <!-- Recent Activity -->
      <section class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h2 class="text-xl font-semibold text-white mb-4">Recent Activity</h2>
        <div id="recentActivity" class="space-y-2">
          <!-- Recent tasks will be populated here -->
        </div>
      </section>
    </main>

    <!-- Tooltip -->
    <div id="tooltip" class="absolute bg-gray-700 text-white text-xs rounded px-2 py-1 pointer-events-none opacity-0 transition-opacity z-50"></div>

    <script>
      let taskData = {};

      async function loadDashboard() {
        try {
          const response = await fetch('/task-stats');
          taskData = await response.json();
          updateStats();
          createContributionGraph();
          updateGoalBreakdown();
          updateRecentActivity();
        } catch (error) {
          console.error('Failed to load dashboard data:', error);
        }
      }

      function updateStats() {
        document.getElementById('currentStreak').textContent = taskData.current_streak || 0;
        document.getElementById('totalTasks').textContent = taskData.total_tasks || 0;
        document.getElementById('uniqueDays').textContent = taskData.unique_days || 0;
        document.getElementById('longestStreak').textContent = taskData.longest_streak || 0;
        
        const avgPerDay = taskData.unique_days > 0 ? 
          (taskData.total_tasks / taskData.unique_days).toFixed(1) : 0;
        document.getElementById('avgPerDay').textContent = avgPerDay;
        
        document.getElementById('goalCount').textContent = Object.keys(taskData.goal_stats || {}).length;
      }

      function createContributionGraph() {
        const graphContainer = document.getElementById('contributionGraph');
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 364); // Last 365 days
        
        // Create date map
        const dateMap = {};
        taskData.daily_data.forEach(day => {
          dateMap[day.date] = day.count;
        });
        
        // Create SVG
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '828');
        svg.setAttribute('height', '128');
        svg.setAttribute('viewBox', '0 0 828 128');
        
        // Create contribution boxes
        let weekCount = 0;
        let currentDate = new Date(startDate);
        
        while (currentDate <= today) {
          const dayOfWeek = currentDate.getDay();
          const weekOfYear = Math.floor((currentDate - startDate) / (7 * 24 * 60 * 60 * 1000));
          
          const x = weekOfYear * 15 + 10;
          const y = dayOfWeek * 15 + 10;
          
          const dateKey = currentDate.toISOString().split('T')[0];
          const count = dateMap[dateKey] || 0;
          const level = Math.min(4, Math.ceil(count / 2));
          
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', x);
          rect.setAttribute('y', y);
          rect.setAttribute('width', '11');
          rect.setAttribute('height', '11');
          rect.setAttribute('rx', '2');
          rect.setAttribute('class', `contribution-box level-${level}`);
          rect.setAttribute('data-date', dateKey);
          rect.setAttribute('data-count', count);
          
          // Add tooltip events
          rect.addEventListener('mouseenter', showTooltip);
          rect.addEventListener('mouseleave', hideTooltip);
          
          svg.appendChild(rect);
          
          currentDate.setDate(currentDate.getDate() + 1);
        }
        
        graphContainer.appendChild(svg);
      }

      function showTooltip(event) {
        const tooltip = document.getElementById('tooltip');
        const date = event.target.getAttribute('data-date');
        const count = event.target.getAttribute('data-count');
        
        const formattedDate = new Date(date).toLocaleDateString('en-US', {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        tooltip.innerHTML = `
          <div class="font-semibold">${formattedDate}</div>
          <div>${count} task${count !== '1' ? 's' : ''} completed</div>
        `;
        
        tooltip.style.opacity = '1';
        
        const rect = event.target.getBoundingClientRect();
        tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + 'px';
        tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';
      }

      function hideTooltip() {
        document.getElementById('tooltip').style.opacity = '0';
      }

      function updateGoalBreakdown() {
        const container = document.getElementById('goalBreakdown');
        container.innerHTML = '';
        
        const goalStats = taskData.goal_stats || {};
        const totalTasks = taskData.total_tasks || 0;
        
        Object.entries(goalStats).forEach(([goal, count]) => {
          const percentage = totalTasks > 0 ? (count / totalTasks * 100).toFixed(1) : 0;
          
          const goalDiv = document.createElement('div');
          goalDiv.className = 'flex items-center justify-between';
          goalDiv.innerHTML = `
            <div class="flex-1">
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium text-gray-200">${goal}</span>
                <span class="text-sm text-gray-400">${count} tasks (${percentage}%)</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-amber-400 to-orange-500 h-2 rounded-full transition-all duration-500" 
                     style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
          container.appendChild(goalDiv);
        });
      }

      function updateRecentActivity() {
        const container = document.getElementById('recentActivity');
        container.innerHTML = '';
        
        const recentData = taskData.daily_data || [];
        const sortedData = recentData.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = sortedData.slice(0, 10);
        
        if (recent.length === 0) {
          container.innerHTML = '<div class="text-gray-400 text-center py-4">No recent activity</div>';
          return;
        }
        
        recent.forEach(day => {
          const date = new Date(day.date);
          const formattedDate = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
          });
          
          const dayDiv = document.createElement('div');
          dayDiv.className = 'flex items-center justify-between p-3 bg-gray-700 rounded-lg';
          dayDiv.innerHTML = `
            <div>
              <div class="font-medium text-gray-200">${formattedDate}</div>
              <div class="text-sm text-gray-400">${day.count} task${day.count !== 1 ? 's' : ''} completed</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-400">
                ${day.tasks.slice(0, 2).map(t => t.task_name).join(', ')}
                ${day.tasks.length > 2 ? ` +${day.tasks.length - 2} more` : ''}
              </div>
            </div>
          `;
          container.appendChild(dayDiv);
        });
      }

      // Load dashboard on page load
      document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
  </body>
</html>
